pipeline {
    agent {
        kubernetes {
            inheritFrom 'jenkins-jenkins-agent'
            idleMinutes 5
            yaml '''
              apiVersion: v1
              kind: Pod
              spec:
                restartPolicy: Never
                containers:
                  - name: kbctl-helm
                    image: aksacrops.azurecr.io/kbctl-helm:v1
                    command: ["tail", "-f", "/dev/null"]
                    imagePullPolicy: IfNotPresent
                    securityContext:
                      privileged: true                      
            '''
            defaultContainer 'jnlp'
        }
    }
    stages {
        stage('Git Details') {
            steps {
              sh "git clone https://github.com/manikcloud/microservices-calculator.git"
            }
        }        
        stage('Get Commit ID') {
            steps {
                
                dir('${WORKSPACE}/microservices-calculator/') {
                    script {
                        env.DOCKER_TAG = sh(script: 'git log --format="%h" -n 1', returnStdout: true).trim()
                        env.DOCKER_IMAGE = "aksacrapp.azurecr.io/calc:${env.DOCKER_TAG}"
                    }
                }
            }
        }

        stage('CD') {
            steps {
                container('kbctl-helm') {
                    sh "helm upgrade --install ${env.ENVIRONMENT}-${env.APP_NAME} golden-chart/ -n ${env.ENVIRONMENT}-${env.APP_NAME} -f  ${env.ENVIRONMENT}/${env.APP_NAME}/values.yaml --set=image.tag=${env.DOCKER_TAG}"
                    sh "helm ls -A"
                }
            }
        }
    }
}
